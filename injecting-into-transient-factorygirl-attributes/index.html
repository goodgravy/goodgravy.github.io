<!DOCTYPE html>
<html lang="">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.69.2 with theme Tranquilpeak 0.4.7-BETA">
<meta name="author" content="James Brady">
<meta name="keywords" content="tech">
<meta name="description" content="I was just writing some code which parses a URL in order to extract a piece of the path.
When working correctly, the code under test takes a URL something like this:
http://site.com/.well-known/pki-validation/4b1706977f59ffe3c1ddf282bbee6f45.txt … and returns just the hash-like part of the path: 4b1706977f59ffe3c1ddf282bbee6f45.
Creating factories to effectively test it was surprisingly fiddly! Here are the options I considered and what worked for me – in the hope it&rsquo;s of some use to you.">


<meta property="og:description" content="I was just writing some code which parses a URL in order to extract a piece of the path.
When working correctly, the code under test takes a URL something like this:
http://site.com/.well-known/pki-validation/4b1706977f59ffe3c1ddf282bbee6f45.txt … and returns just the hash-like part of the path: 4b1706977f59ffe3c1ddf282bbee6f45.
Creating factories to effectively test it was surprisingly fiddly! Here are the options I considered and what worked for me – in the hope it&rsquo;s of some use to you.">
<meta property="og:type" content="article">
<meta property="og:title" content="Injecting into transient FactoryGirl attributes">
<meta name="twitter:title" content="Injecting into transient FactoryGirl attributes">
<meta property="og:url" content="https://jmsbrdy.com/injecting-into-transient-factorygirl-attributes/">
<meta property="twitter:url" content="https://jmsbrdy.com/injecting-into-transient-factorygirl-attributes/">
<meta property="og:site_name" content="jmsbrdy.com">
<meta property="og:description" content="I was just writing some code which parses a URL in order to extract a piece of the path.
When working correctly, the code under test takes a URL something like this:
http://site.com/.well-known/pki-validation/4b1706977f59ffe3c1ddf282bbee6f45.txt … and returns just the hash-like part of the path: 4b1706977f59ffe3c1ddf282bbee6f45.
Creating factories to effectively test it was surprisingly fiddly! Here are the options I considered and what worked for me – in the hope it&rsquo;s of some use to you.">
<meta name="twitter:description" content="I was just writing some code which parses a URL in order to extract a piece of the path.
When working correctly, the code under test takes a URL something like this:
http://site.com/.well-known/pki-validation/4b1706977f59ffe3c1ddf282bbee6f45.txt … and returns just the hash-like part of the path: 4b1706977f59ffe3c1ddf282bbee6f45.
Creating factories to effectively test it was surprisingly fiddly! Here are the options I considered and what worked for me – in the hope it&rsquo;s of some use to you.">
<meta property="og:locale" content="en">

  
    <meta property="article:published_time" content="2017-08-01T00:00:00">
  
  
    <meta property="article:modified_time" content="2017-08-01T00:00:00">
  
  
  
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@goodgravy">


  <meta name="twitter:creator" content="@goodgravy">






  <meta property="og:image" content="https://res.cloudinary.com/dshgddh17/c_lfill,g_center,h_280,w_280/jmsbrdy.com/factory.jpg">
  <meta property="twitter:image" content="https://res.cloudinary.com/dshgddh17/c_lfill,g_center,h_280,w_280/jmsbrdy.com/factory.jpg">





  <meta property="og:image" content="https://www.gravatar.com/avatar/363e08c01d9caf37d45bf6e5a011421b?s=640">
  <meta property="twitter:image" content="https://www.gravatar.com/avatar/363e08c01d9caf37d45bf6e5a011421b?s=640">


    <title>Injecting into transient FactoryGirl attributes</title>

    <link rel="icon" href="/favicon.ico">
    

    

    <link rel="canonical" href="https://jmsbrdy.com/injecting-into-transient-factorygirl-attributes/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/">jmsbrdy.com</a>
  </div>
  
    
      <a class="header-right-picture "
         href="/#about">
    
    
    
      
        <img class="header-picture" src="https://www.gravatar.com/avatar/363e08c01d9caf37d45bf6e5a011421b?s=90" alt="" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/363e08c01d9caf37d45bf6e5a011421b?s=110" alt="" />
        </a>
        <h4 class="sidebar-profile-name">James Brady</h4>
        
          <h5 class="sidebar-profile-bio">I&rsquo;m a software engineer by trade and an woodworker for fun. I like hard problems and learning new things with which solve them. I&rsquo;m learning to speak Catalan. I like hiking up hills and mountain biking down them. I play the trumpet poorly. That is all.</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/goodgravy" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://linkedin.com/in/goodgravy" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-linkedin"></i>
      
      <span class="sidebar-button-desc">LinkedIn</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Injecting into transient FactoryGirl attributes
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
    
  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>I was just writing some code which parses a URL in order to extract a piece of the path.</p>
<p>When working correctly, the code under test takes a URL something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">http://site.com/.well-known/pki-validation/4b1706977f59ffe3c1ddf282bbee6f45.txt
</code></pre></div><p>… and returns just the hash-like part of the path: <code>4b1706977f59ffe3c1ddf282bbee6f45</code>.</p>
<p>Creating factories to effectively test it was surprisingly fiddly! Here are the options I considered and what worked for me – in the hope it&rsquo;s of some use to you.</p>
<h2 id="static-value">Static value</h2>
<p>The simplest approach would be to just use a static value for the URL in the factory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">factory <span style="color:#e6db74">:response</span> <span style="color:#66d9ef">do</span>
  ssl_http_url <span style="color:#e6db74">&#34;http://site.com/.well-known/pki-validation/4b1706977f59ffe3c1ddf282bbee6f45.txt&#34;</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>Then, in my tests I could do something like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">expect(my_class<span style="color:#f92672">.</span>parse_response)<span style="color:#f92672">.</span>to eq(<span style="color:#e6db74">&#39;4b1706977f59ffe3c1ddf282bbee6f45&#39;</span>)
</code></pre></div><table>
<thead>
<tr>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>super</strong> simple</td>
<td>URL never changes: we&rsquo;re not exercising the code as much as we might</td>
</tr>
<tr>
<td>we need to look at the factory definition to know what the correct subpath is</td>
<td></td>
</tr>
</tbody>
</table>
<p>Overall, a weak but workable approach.</p>
<h2 id="dynamic-value-sequence">Dynamic value: sequence</h2>
<p>To address these problems (kind-of), we could use a dynamic value with a sequence, like so:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">factory <span style="color:#e6db74">:response</span> <span style="color:#66d9ef">do</span>
sequence(<span style="color:#e6db74">:ssl_http_url</span>) { <span style="color:#f92672">|</span>n<span style="color:#f92672">|</span> <span style="color:#e6db74">&#34;http://site.com/.well-known/pki-validation/</span><span style="color:#e6db74">#{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">.txt&#34;</span> }
<span style="color:#66d9ef">end</span>
</code></pre></div><p>This would generate URLs like so:</p>
<ul>
<li><code>http://site.com/.well-known/pki-validation/1.txt</code></li>
<li><code>http://site.com/.well-known/pki-validation/2.txt</code></li>
<li><code>http://site.com/.well-known/pki-validation/3.txt</code></li>
<li>etc.</li>
</ul>
<table>
<thead>
<tr>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td>the generated URLs are unrealistic</td>
<td></td>
</tr>
<tr>
<td>no way to <strong>reliably</strong> know what the subpath should be</td>
<td></td>
</tr>
</tbody>
</table>
<p>Overall, this is an even weaker approach than a static value. For the test code to know what subpath it should expect your code to produce, we have to rely on the incrementing sequence numbers. But what happens if you add a <code>before</code> block which creates a new <code>response</code>? All of a sudden all your expectations have off-by-one errors in their expectations.</p>
<h2 id="dynamic-value-random-url">Dynamic value: random URL</h2>
<p>How about the factory randomly generates a URL of the right form?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">factory <span style="color:#e6db74">:response</span> <span style="color:#66d9ef">do</span>
  ssl_http_url <span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">#{</span> <span style="color:#66d9ef">Faker</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Internet</span><span style="color:#f92672">.</span>domain_name <span style="color:#e6db74">}</span><span style="color:#e6db74">/.well-known/pki-validation/</span><span style="color:#e6db74">#{</span> <span style="color:#66d9ef">Faker</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Crypto</span><span style="color:#f92672">.</span>md5 <span style="color:#e6db74">}</span><span style="color:#e6db74">.txt&#34;</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>This would generate URLs like so:</p>
<ul>
<li><code>http://gaylordmraz.io/.well-known/pki-validation/e8bfe6eda36585d2d18bb665096c16da.txt</code></li>
<li><code>http://boyle.org/.well-known/pki-validation/16fe4249b256a74bc10144542b35ea5e.txt</code></li>
<li><code>http://faheylakin.co/.well-known/pki-validation/7434184363b29d07dac7a11698bf86fe.txt</code></li>
</ul>
<p>They are realistic <em>and</em> they change, which means your code is better exercised.</p>
<p>However, the problem now is that the test code doesn&rsquo;t know what value to expect. Because the md5 hash which forms the subpath is random, we don&rsquo;t know if the code under test is doing the right thing without reimplementing the parsing logic in the test itself!</p>
<p>Implementing a shadow version of the production code logic just to test the production code is a nightmarish smell.</p>
<h2 id="dynamic-value-injecting-a-value">Dynamic value: injecting a value</h2>
<p>What I really wanted was for the URL to be randomly generated, but for the test code to know what subpath value to expect.</p>
<p>FactoryGirl has a handy way of achieving this, but unfortunately it&rsquo;s documented in a confusing manner.</p>
<p><strong>Transient</strong> or <strong>ignored</strong> attributes are properties which you can set on your FactoryGirl factories, but which don&rsquo;t need to exist on the underlying class. They aren&rsquo;t available for use on the generated objects either – they exist only in the scope of generating the object.</p>
<p>The confusion comes in because they&rsquo;re called ignored attributes in <a href="https://github.com/thoughtbot/factory_girl/blob/v4.4.0/GETTING_STARTED.md#transient-attributes">version 4.4.0</a> but transient attributes in <a href="https://github.com/thoughtbot/factory_girl/blob/v4.5.0/GETTING_STARTED.md#transient-attributes">version 4.5.0</a>, which breaks semver….</p>
<p>However, with a factory defined like so:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">factory <span style="color:#e6db74">:response</span> <span style="color:#66d9ef">do</span>
  ssl_http_url { <span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">#{</span> <span style="color:#66d9ef">Faker</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Internet</span><span style="color:#f92672">.</span>domain_name <span style="color:#e6db74">}</span><span style="color:#e6db74">/.well-known/pki-validation/</span><span style="color:#e6db74">#{</span>url_subpath<span style="color:#e6db74">}</span><span style="color:#e6db74">.txt&#34;</span> }

  <span style="color:#75715e"># if you&#39;re using FactoryGirl &lt; 4.5.0</span>
  ignore <span style="color:#66d9ef">do</span>
    url_subpath { <span style="color:#66d9ef">Faker</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Crypto</span><span style="color:#f92672">.</span>md5 }
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>You can pass in a value for <code>url_subpath</code> and test to your heart&rsquo;s content, e.g.:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">subpath <span style="color:#f92672">=</span> <span style="color:#66d9ef">Faker</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Crypto</span><span style="color:#f92672">.</span>md5
response <span style="color:#f92672">=</span> <span style="color:#66d9ef">FG</span><span style="color:#f92672">.</span>create(<span style="color:#e6db74">:response</span>, <span style="color:#e6db74">url_subpath</span>: subpath)
expect(my_class<span style="color:#f92672">.</span>parse_response)<span style="color:#f92672">.</span>to eq(subpath)
</code></pre></div><table>
<thead>
<tr>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td>URLs are randomised</td>
<td></td>
</tr>
<tr>
<td>generated URLs are realistic</td>
<td></td>
</tr>
<tr>
<td>test code knows what subpath to expect</td>
<td></td>
</tr>
</tbody>
</table>

              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/swamp-cooler-experimenting-with-airflow/" data-tooltip="Swamp cooler: experimenting with airflow">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml"></span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/swamp-coolers-for-the-house/" data-tooltip="Swamp coolers for the house?">
              
                  <span class="hide-xs hide-sm text-small icon-mr"></span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 James Brady. 
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/swamp-cooler-experimenting-with-airflow/" data-tooltip="Swamp cooler: experimenting with airflow">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml"></span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/swamp-coolers-for-the-house/" data-tooltip="Swamp coolers for the house?">
              
                  <span class="hide-xs hide-sm text-small icon-mr"></span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.gravatar.com/avatar/363e08c01d9caf37d45bf6e5a011421b?s=110" alt="" />
    
    <h4 id="about-card-name">James Brady</h4>
    
      <div id="about-card-bio">I&rsquo;m a software engineer by trade and an woodworker for fun. I like hard problems and learning new things with which solve them. I&rsquo;m learning to speak Catalan. I like hiking up hills and mountain biking down them. I play the trumpet poorly. That is all.</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        <a href="https://teespring.com">Teespring</a>
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Oristà: a teeny tiny village in Catalunya
      </div>
    
  </div>
</div>

    

    
  
    
      
      <div id="cover" style="background-image:url('https://jmsbrdy.com/images/sebastia.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>


  
    
  




    
  </body>
</html>

